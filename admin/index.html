<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin</title>
  </head>
  <body>
    <!-- 1) Desativa auto-init ANTES do script do Decap -->
    <script>
      window.CMS_MANUAL_INIT = true;
    </script>

    <!-- 2) Carrega a versão mais recente 3.x -->
    <script src="https://unpkg.com/decap-cms@^3.3.0/dist/decap-cms.js"></script>

    <!-- 3) Inicializa manualmente -->
    <script>
      CMS.init({
        config: {
          backend: {
            name: "github",
            repo: "Igor-96/croche-a-luz-de-velas",   // nome EXATO do seu repo
            branch: "main",
            base_url: "https://crochealuzdevelas.vercel.app",
            auth_endpoint: "/api/authorize"
          },
          media_folder: "assets/uploads",
          public_folder: "/assets/uploads",
          collections: [
            {
              name: "catalogo",
              label: "Catálogo",
              files: [
                {
                  file: "data/content.json",
                  label: "Conteúdo da Loja",
                  name: "conteudo",
                  fields: [
                    { label:"Produtos (home)", name:"PRODUCTS", widget:"list", fields:[
                      {label:"ID", name:"id", widget:"string"},
                      {label:"Título", name:"title", widget:"string"},
                      {label:"Preço", name:"price", widget:"number", value_type:"float"},
                      {label:"Tag", name:"tag", widget:"string"},
                      {label:"Imagem", name:"img", widget:"image"},
                      {label:"Destaque", name:"featured", widget:"boolean", default:false},
                      {label:"Descrição", name:"blurb", widget:"text", required:false}
                    ]},
                    { label:"Crochês", name:"CROCHES", widget:"list", fields:[
                      {label:"ID", name:"id", widget:"string"},
                      {label:"Título", name:"title", widget:"string"},
                      {label:"Preço", name:"price", widget:"number", value_type:"float"},
                      {label:"Tag", name:"tag", widget:"string"},
                      {label:"Imagem", name:"img", widget:"image"},
                      {label:"Descrição", name:"blurb", widget:"text", required:false}
                    ]},
                    { label:"Velas", name:"VELAS", widget:"list", fields:[
                      {label:"ID", name:"id", widget:"string"},
                      {label:"Título", name:"title", widget:"string"},
                      {label:"Preço", name:"price", widget:"number", value_type:"float"},
                      {label:"Tag", name:"tag", widget:"string"},
                      {label:"Imagem", name:"img", widget:"image"},
                      {label:"Descrição", name:"blurb", widget:"text", required:false}
                    ]}
                  ]
                }
              ]
            }
          ]
        }
      });
    </script>

   <script>
      // Evita múltiplas execuções
      const LOGIN_GUARD_KEY = "decap_login_done";

      function finishLogin(token) {
        if (sessionStorage.getItem(LOGIN_GUARD_KEY) === "1") return;
        sessionStorage.setItem(LOGIN_GUARD_KEY, "1");

        // grava como o Decap espera
        try {
          localStorage.setItem("netlify-cms-user", JSON.stringify({ token, provider: "github" }));
          localStorage.setItem("decap-cms-auth", JSON.stringify({ token, provider: "github" }));
          localStorage.removeItem("decap_token"); // consome e apaga o token único
        } catch(_) {}

        // conclui o fluxo do CMS (se disponível)
        try { if (window.CMS && CMS.oauthComplete) CMS.oauthComplete({ token, provider: "github" }); } catch (_) {}

        // só navega para uma rota do painel; NÃO recarrega a página
        if (!location.hash || location.hash === "#/" || location.hash.startsWith("#/login")) {
          location.hash = "#/collections/catalogo";
        }
      }

      // 1) Recebe do popup
      window.addEventListener("message", (e) => {
        try {
          if (typeof e.data === "string" && e.data.startsWith("authorization:github:")) {
            finishLogin(e.data.split(":").pop());
            return;
          }
          if (e.data && e.data.token) {
            finishLogin(e.data.token);
            return;
          }
        } catch (_) {}
      }, false);

      // 2) Fallback imediato: usa o token salvo pelo callback
      (function pickupOnce(){
        if (sessionStorage.getItem(LOGIN_GUARD_KEY) === "1") return;
        try {
          const t = localStorage.getItem("decap_token");
          if (t) finishLogin(t);
        } catch(_) {}
      })();

      // 3) Polling curto (para quando o popup fecha antes do setItem propagar)
      (function pollForToken(){
        if (sessionStorage.getItem(LOGIN_GUARD_KEY) === "1") return;
        let tries = 0;
        const maxTries = 40; // ~12s
        const iv = setInterval(() => {
          if (sessionStorage.getItem(LOGIN_GUARD_KEY) === "1") { clearInterval(iv); return; }
          tries++;
          try {
            const t = localStorage.getItem("decap_token");
            if (t) { finishLogin(t); clearInterval(iv); return; }
          } catch(_) {}
          if (tries >= maxTries) clearInterval(iv);
        }, 300);
      })();
    </script>


  </body>
</html>

