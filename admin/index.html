<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin</title>
  </head>
  <body>
    <!-- 1) Desativa auto-init ANTES do script do Decap -->
    <script>
      window.CMS_MANUAL_INIT = true;
    </script>

    <!-- 2) Carrega a versão mais recente 3.x -->
    <script src="https://unpkg.com/decap-cms@^3.3.0/dist/decap-cms.js"></script>

    <!-- 3) Inicializa manualmente -->
    <script>
      CMS.init({
        config: {
          backend: {
            name: "github",
            repo: "Igor-96/croche-a-luz-de-velas",   // nome EXATO do seu repo
            branch: "main",
            base_url: "https://crochealuzdevelas.vercel.app",
            auth_endpoint: "/api/authorize"
          },
          media_folder: "assets/uploads",
          public_folder: "/assets/uploads",
          collections: [
            {
              name: "catalogo",
              label: "Catálogo",
              files: [
                {
                  file: "data/content.json",
                  label: "Conteúdo da Loja",
                  name: "conteudo",
                  fields: [
                    { label:"Produtos (home)", name:"PRODUCTS", widget:"list", fields:[
                      {label:"ID", name:"id", widget:"string"},
                      {label:"Título", name:"title", widget:"string"},
                      {label:"Preço", name:"price", widget:"number", value_type:"float"},
                      {label:"Tag", name:"tag", widget:"string"},
                      {label:"Imagem", name:"img", widget:"image"},
                      {label:"Destaque", name:"featured", widget:"boolean", default:false},
                      {label:"Descrição", name:"blurb", widget:"text", required:false}
                    ]},
                    { label:"Crochês", name:"CROCHES", widget:"list", fields:[
                      {label:"ID", name:"id", widget:"string"},
                      {label:"Título", name:"title", widget:"string"},
                      {label:"Preço", name:"price", widget:"number", value_type:"float"},
                      {label:"Tag", name:"tag", widget:"string"},
                      {label:"Imagem", name:"img", widget:"image"},
                      {label:"Descrição", name:"blurb", widget:"text", required:false}
                    ]},
                    { label:"Velas", name:"VELAS", widget:"list", fields:[
                      {label:"ID", name:"id", widget:"string"},
                      {label:"Título", name:"title", widget:"string"},
                      {label:"Preço", name:"price", widget:"number", value_type:"float"},
                      {label:"Tag", name:"tag", widget:"string"},
                      {label:"Imagem", name:"img", widget:"image"},
                      {label:"Descrição", name:"blurb", widget:"text", required:false}
                    ]}
                  ]
                }
              ]
            }
          ]
        }
      });
    </script>

    <!-- 4) Listener do popup + forçar conclusão/refresh -->
    <script>
      function finishLogin(token) {
        try {
          if (window.CMS && CMS.oauthComplete) {
            CMS.oauthComplete({ token, provider: "github" });
          }
        } catch (e) { console.warn("oauthComplete error:", e); }
        // força hash da página do painel e recarrega UI
        try { window.location.hash = "#/collections/catalogo"; } catch(_) {}
        try { setTimeout(() => window.location.reload(), 200); } catch(_) {}
      }

      window.addEventListener("message", (e) => {
        try {
          console.log("OAuth message:", e.data);
          if (typeof e.data === "string" && e.data.startsWith("authorization:github:")) {
            const token = e.data.split(":").pop();
            finishLogin(token);
            return;
          }
          if (e.data && e.data.token) {
            finishLogin(e.data.token);
            return;
          }
        } catch (err) {
          console.warn("message handler error:", err);
        }
      }, false);
    </script>

    <!-- 5) Fallback: token salvo pelo callback -->
    <script>
      (function pickupLocalToken(){
        try {
          const t = localStorage.getItem("decap_token");
          if (t) {
            console.log("Found token in localStorage");
            localStorage.removeItem("decap_token");
            finishLogin(t);
          }
        } catch(e) {}
      })();
    </script>

    <!-- 6) Polling extra (quando o popup fecha rápido) -->
    <script>
      (function pollForToken(){
        let tries = 0;
        const maxTries = 60; // ~18s
        const iv = setInterval(() => {
          tries++;
          try {
            const t = localStorage.getItem("decap_token");
            if (t) {
              console.log("Polling got token");
              localStorage.removeItem("decap_token");
              finishLogin(t);
              clearInterval(iv);
            }
          } catch(e){}
          if (tries >= maxTries) clearInterval(iv);
        }, 300);
      })();
    </script>
  </body>
</html>

