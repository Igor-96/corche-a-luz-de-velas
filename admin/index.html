<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin</title>
  </head>
  <body>
    <!-- 1) Primeiro: desativa auto-init -->
    <script>
      window.CMS_MANUAL_INIT = true;
    </script>

    <!-- 2) Depois: carrega o Decap CMS -->
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>

    <!-- 3) Por fim: inicializa manualmente com sua config -->
    <script>
      CMS.init({
        config: {
          backend: {
            name: "github",
            repo: "Igor-96/croche-a-luz-de-velas",   // seu repositório exato
            branch: "main",
            base_url: "https://crochealuzdevelas.vercel.app",
            auth_endpoint: "/api/authorize"
          },
          media_folder: "assets/uploads",
          public_folder: "/assets/uploads",
          collections: [
            {
              name: "catalogo",
              label: "Catálogo",
              files: [
                {
                  file: "data/content.json",
                  label: "Conteúdo da Loja",
                  name: "conteudo",
                  fields: [
                    { label:"Produtos (home)", name:"PRODUCTS", widget:"list", fields:[
                      {label:"ID", name:"id", widget:"string"},
                      {label:"Título", name:"title", widget:"string"},
                      {label:"Preço", name:"price", widget:"number", value_type:"float"},
                      {label:"Tag", name:"tag", widget:"string"},
                      {label:"Imagem", name:"img", widget:"image"},
                      {label:"Destaque", name:"featured", widget:"boolean", default:false},
                      {label:"Descrição", name:"blurb", widget:"text", required:false}
                    ]},
                    { label:"Crochês", name:"CROCHES", widget:"list", fields:[
                      {label:"ID", name:"id", widget:"string"},
                      {label:"Título", name:"title", widget:"string"},
                      {label:"Preço", name:"price", widget:"number", value_type:"float"},
                      {label:"Tag", name:"tag", widget:"string"},
                      {label:"Imagem", name:"img", widget:"image"},
                      {label:"Descrição", name:"blurb", widget:"text", required:false}
                    ]},
                    { label:"Velas", name:"VELAS", widget:"list", fields:[
                      {label:"ID", name:"id", widget:"string"},
                      {label:"Título", name:"title", widget:"string"},
                      {label:"Preço", name:"price", widget:"number", value_type:"float"},
                      {label:"Tag", name:"tag", widget:"string"},
                      {label:"Imagem", name:"img", widget:"image"},
                      {label:"Descrição", name:"blurb", widget:"text", required:false}
                    ]}
                  ]
                }
              ]
            }
          ]
        }
      });
      </script>
    
      <script>
      // 1) Listener normal (quando o popup envia postMessage)
      window.addEventListener("message", (e) => {
        try {
          // formatos que o callback envia
          if (typeof e.data === "string" && e.data.startsWith("authorization:github:")) {
            const token = e.data.split(":").pop();
            if (window.CMS && CMS.oauthComplete) CMS.oauthComplete({ token, provider: "github" });
            return;
          }
          if (e.data && e.data.token) {
            if (window.CMS && CMS.oauthComplete) CMS.oauthComplete({ token: e.data.token, provider: "github" });
            return;
          }
        } catch(_) {}
      }, false);

      // 2) Fallback: busca token salvo no localStorage pelo callback
      (function pickupLocalToken(){
        try {
          const t = localStorage.getItem("decap_token");
          if (t) {
            localStorage.removeItem("decap_token");
            if (window.CMS && CMS.oauthComplete) CMS.oauthComplete({ token: t, provider: "github" });
          }
         } catch(_) {}
       })();
      </script>

      <script>
  // --- POLLING: procura pelo token salvo pelo /api/callback ---
      (function pollForToken(){
        let tries = 0;
        const maxTries = 60;   // ~18s (60 * 300ms)

        const iv = setInterval(() => {
          tries++;
          try {
            const t = localStorage.getItem("decap_token");
            if (t) {
              localStorage.removeItem("decap_token");
              if (window.CMS && CMS.oauthComplete) {
                CMS.oauthComplete({ token: t, provider: "github" });
              }
              clearInterval(iv);
            }
          } catch(e){ /* ignore */ }

          if (tries >= maxTries) clearInterval(iv);
         }, 300);
       })();
      </script>

  </body>
</html>
